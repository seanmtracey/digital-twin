<main>

    <header>
        <h2>Digital Twins</h2>
    </header>
	
    <ul id="twins">
        {{#each twins}}

            <li class="item" style="background-image: url('/images/placeholder-twin.jpg')">
                <div class="viewOptions">
                    <a href="/view/{{UUID}}">View</a>
                    <a href="/edit/{{UUID}}">Edit</a>
                </div>
                <a class="subOptionsToggle"><img src="images/sub-menu-icon.png"></a>
                <ul class="subOptions" data-visible="false">
                    <li data-action="edit">Edit Settings</li>
                    <li data-action="duplicate">Duplicate Twin</li>
                    <li data-action="delete">Delete Twin</li>
                </ul>
                <div class="details">
                    <h3>{{name}}</h3>
                    <p>Created by {{owner}}</p>
                </div>
            </li>

        {{/each}}
        
        <!--<li class="item" style="background-image: url('/images/placeholder-twin.jpg')">
            <div class="viewOptions">
                <a href="/view">View</a>
                <a href="/edit">Edit</a>
            </div>
            <a class="subOptionsToggle"><img src="images/sub-menu-icon.png"></a>
            <ul class="subOptions" data-visible="false">
                <li>Duplicate</li>
                <li>Delete</li>
            </ul>
            <div class="details">
                <h3>First Twin</h3>
                <p>Created by Sean M. Tracey</p>
            </div>
        </li>-->

        <li class="item" id="createNew" data-active="false"> </li>
    </ul>

    <div id="createTwinDialog" data-visible="false">
        <div class="wrapper">
            <div id="closeCreationDialog" class="closeDialogBtn"></div>
            <h3>Create new Digital Twin</h3>
            <form>
                <input type="text" name="twinname" placeholder="Enter Digital Twin name" />
                <input type="text" name="twinbroker" placeholder="Enter MQTT broker address for twin" />
                <input type="submit" value="Create Twin" />
            </form>
        </div>
    </div>

</main>

<script>

    (function(){

        'use strict';

        Array.from( document.querySelectorAll('#twins .item .subOptionsToggle') ).forEach(subOptionsToggle => {

            subOptionsToggle.addEventListener('click', function(e){

                const options = this.parentNode.querySelector('.subOptions');

                if(options.dataset.visible === "false"){
                    options.dataset.visible = "true";
                } else {
                    options.dataset.visible = "false";
                }

            }, false);

        });

        const createTwinBtn = document.querySelector("#createNew");
        const createTwinDialog = document.querySelector('#createTwinDialog');
        const closeCreateDialogBtn = createTwinDialog.querySelector('.closeDialogBtn');
        const createTwinForm = createTwinDialog.querySelector('form');

        createTwinForm.addEventListener('submit', function(e){

            e.preventDefault();
            e.stopImmediatePropagation();

            fetch(`/twins/create`, {
                    method : "POST",
                    headers : {
                        "Content-Type" : "application/json"
                    },
                    body : JSON.stringify({
                        name : this[0].value,
                        broker : this[1].value
                    })
                })
                .then(response => {
                    if(response.ok){
                        return response.json();
                    } else {
                        throw response;
                    }
                })
                .then(response => {
                    console.log(response);
                    window.location = `/edit/${response.data.UUID}`;
                })
                .catch(err => {
                    console.log("Create twin err:", err);
                })
            ;

        }, false);

        createTwinBtn.addEventListener('click', function(e){
            e.preventDefault();

            createTwinForm.reset();
            createTwinDialog.dataset.visible = "true";

        }, false);

        closeCreateDialogBtn.addEventListener('click', function(e){
            
            createTwinDialog.dataset.visible = "false";
            createTwinForm.reset();

        }, false);

    }());

</script>